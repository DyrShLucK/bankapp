pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = credentials('DOCKER_REGISTRY')
        DB_PASSWORD     = credentials('DB_PASSWORD')
        GITHUB_USERNAME = credentials('GITHUB_USERNAME')
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        NAMESPACE_DEV = 'kafka-dev'
        NAMESPACE_PROD = 'kafka-prod'
        MONITORING_NAMESPACE = 'monitoring-dev'
    }

    stages {
        stage('Setup Helm Repos') {
            steps {
                sh '''
                helm repo add bitnami https://raw.githubusercontent.com/bitnami/charts/refs/heads/archive-full-index/bitnami/
                helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
                helm repo update
                '''
            }
        }

        stage('Deploy Monitoring Stack') {
            steps {
                dir('charts/logs') {
                    sh '''
                    //helm upgrade --install zipkin bitnami/zipkin \
                    //  --namespace ${MONITORING_NAMESPACE} \
                    //  --create-namespace \
                    //  -f zipkin/values-dev.yaml
                    //helm upgrade --install prometheus prometheus-community/prometheus \
                    //  --namespace ${MONITORING_NAMESPACE} \
                    //  --create-namespace \
                    //  -f monitoring/values-dev.yaml
                    '''
                }
            }
        }

        stage('Verify Monitoring Stack') {
            steps {
                script {
                    //echo "Waiting for Prometheus and Grafana to be ready..."
                    //sh "sleep 30"
                    //sh "kubectl rollout status deployment/monitoring-grafana -n ${MONITORING_NAMESPACE} || true"
                    //sh "kubectl rollout status statefulset/monitoring-kube-prometheus-prometheus -n ${MONITORING_NAMESPACE} || true"
                }
            }
        }
        stage('Deploy ELK Stack') {
                    steps {
                        dir('charts/logs') {
                            sh '''
                            kubectl delete namespace log || true
                            helm dependency update elasticsearch
                            helm upgrade --install elasticsearch ./elasticsearch \
                            --namespace log --create-namespace \
                            -f elasticsearch/values-dev.yaml

                            helm dependency update logstash
                            helm upgrade --install logstash ./logstash  \
                            --namespace log \
                            -f logstash/values-dev.yaml \
                            --set enabled=true \
                            --set kafka.bootstrapServers="kafka.prod.svc.cluster.local:9092" \
                            --set elasticsearch.hosts="http://elasticsearch-elasticsearch.log.svc.cluster.local:9200"

                            helm dependency update kibana
                            helm upgrade --install kibana ./kibana \
                            --namespace log \
                            -f kibana/values-dev.yaml \
                            --set enabled=true \
                            --set elasticsearch.hosts="https://elasticsearch-elasticsearch.log.svc.cluster.local:9200"
                            '''
                        }
                    }
                }

        stage('Clean Up Previous Kafka Installation') {
            steps {
                sh '''
                helm uninstall kafka --namespace kafka-dev || true
                sleep 10
                kubectl delete pvc -n kafka-dev data-kafka-controller-0 data-kafka-controller-1 data-kafka-controller-2 || true
                kubectl delete secret -n kafka-dev kafka-kraft || true
                kubectl delete namespace kafka-dev || true
                sleep 10
                '''
            }
        }

        stage('Deploy Kafka to DEV') {
            steps {
                dir('charts/kafka') {
                    sh '''
                    helm install kafka . --namespace kafka-dev --create-namespace -f values-dev.yaml --set kafka.replicaCount=1
                    '''
                }
            }
        }

        stage('Verify Kafka Deployment') {
            steps {
                script {
                    echo "Waiting for Kafka to be ready..."
                    sh "sleep 60"
                    sh "kubectl rollout status statefulset/kafka-controller -n kafka-dev"
                }
            }
        }

        stage('Create Kafka Topics') {
            steps {
                sh """
                kubectl wait --for=condition=ready pod/kafka-controller-0 -n ${NAMESPACE_DEV} --timeout=3m

                create_topic_if_not_exists() {
                    local topic=\$1
                    if ! kubectl exec -n ${NAMESPACE_DEV} kafka-controller-0 -- kafka-topics.sh --bootstrap-server kafka:9092 --list | grep -q \"^\${topic}\$\"; then
                        echo "Creating topic: \${topic}"
                        kubectl exec -n ${NAMESPACE_DEV} kafka-controller-0 -- kafka-topics.sh --bootstrap-server kafka:9092 --create --topic \${topic} --partitions 1 --replication-factor 1
                    else
                        echo "Topic '\${topic}' already exists. Skipping."
                    fi
                }

                create_topic_if_not_exists "notifications.requests"
                create_topic_if_not_exists "notifications.responses"
                """
            }
        }
    }

    post {
        success {
            echo "Kafka and Monitoring deployed successfully!"
        }
        failure {
            echo "Deployment failed!"
        }
    }
}