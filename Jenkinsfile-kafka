pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = credentials('DOCKER_REGISTRY')
        DB_PASSWORD     = credentials('DB_PASSWORD')
        GITHUB_USERNAME = credentials('GITHUB_USERNAME')
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        NAMESPACE_DEV = 'monitoring-dev'
        NAMESPACE_PROD = 'monitoring-prod'
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ URL
        HELM_REPO_BITNAMI = 'https://raw.githubusercontent.com/bitnami/charts/refs/heads/archive-full-index/bitnami/'
        HELM_REPO_PROMETHEUS = 'https://prometheus-community.github.io/helm-charts'
        HELM_REPO_GRAFANA = 'https://grafana.github.io/helm-charts'
        HELM_REPO_ELASTIC = 'https://helm.elastic.co'
    }

    stages {
        stage('Setup Helm Repo') {
            steps {
                sh '''
                helm repo add bitnami ${HELM_REPO_BITNAMI}
                helm repo add prometheus-community ${HELM_REPO_PROMETHEUS}
                helm repo add grafana ${HELM_REPO_GRAFANA}
                helm repo add elastic ${HELM_REPO_ELASTIC}
                helm repo update
                '''
            }
        }

        stage('Clean Up Previous Kafka Installation') {
            steps {
                sh '''
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ä–µ—Å—É—Ä—Å—ã Kafka –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                helm uninstall kafka --namespace kafka-dev || true
                sleep 10
                # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ PVC
                kubectl delete pvc -n kafka-dev data-kafka-controller-0 data-kafka-controller-1 data-kafka-controller-2 || true
                kubectl delete secret -n kafka-dev kafka-kraft || true
                kubectl delete namespace kafka-dev || true
                sleep 10
                '''
            }
        }
        stage('Prepare DEV Environment') {
            steps {
                sh '''
                kubectl create namespace ${NAMESPACE_DEV} --dry-run=client -o yaml | kubectl apply -f -
                kubectl create namespace kafka-dev --dry-run=client -o yaml | kubectl apply -f -

                # –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                kubectl create secret generic elastic-credentials --from-literal=kibana_password=admin -n ${NAMESPACE_DEV} --dry-run=client -o yaml | kubectl apply -f -
                kubectl create secret generic grafana-admin --from-literal=admin-password=admin -n ${NAMESPACE_DEV} --dry-run=client -o yaml | kubectl apply -f -
                '''
            }
        }
        stage('Deploy Monitoring Stack to DEV') {
            steps {
                dir('charts/logs') {
                    sh '''
                    # Deploy –ø–æ–ª–Ω—ã–π —Å—Ç–µ–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (Prometheus + Grafana + Alertmanager)
                    helm upgrade --install monitoring ./monitoring \
                        --namespace ${NAMESPACE_DEV} \
                        --values monitoring/values-dev.yaml \
                        --create-namespace

                    # Deploy Zipkin –æ—Ç–¥–µ–ª—å–Ω–æ
                    helm upgrade --install zipkin ./zipkin \
                        --namespace ${NAMESPACE_DEV} \
                        --values zipkin/values-dev.yaml \
                        --create-namespace

                    # –ñ–¥–µ–º –ø–æ–∫–∞ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–ø—É—Å—Ç—è—Ç—Å—è
                    echo "Waiting for monitoring components to be ready..."
                    sleep 60

                    kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=prometheus -n ${NAMESPACE_DEV} --timeout=300s || true
                    kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=grafana -n ${NAMESPACE_DEV} --timeout=300s || true
                    kubectl wait --for=condition=Ready pod -l app=zipkin -n ${NAMESPACE_DEV} --timeout=300s || true
                    '''
                }
            }
        }

        stage('Deploy ELK Stack to DEV') {
            steps {
                dir('charts/logs') {
                    sh '''
                    # Deploy Elasticsearch
                    helm upgrade --install elasticsearch ./elasticsearch \
                        --namespace ${NAMESPACE_DEV} \
                        --values elasticsearch/values-dev.yaml \
                        --create-namespace

                    # –ñ–¥–µ–º –ø–æ–∫–∞ Elasticsearch —Å—Ç–∞–Ω–µ—Ç –≥–æ—Ç–æ–≤—ã–º
                    echo "Waiting for Elasticsearch to be ready..."
                    sleep 90

                    # Deploy Logstash
                    helm upgrade --install logstash ./logstash \
                        --namespace ${NAMESPACE_DEV} \
                        --values logstash/values-dev.yaml \
                        --create-namespace

                    # Deploy Kibana
                    helm upgrade --install kibana ./kibana \
                        --namespace ${NAMESPACE_DEV} \
                        --values kibana/values-dev.yaml \
                        --create-namespace

                    # –ñ–¥–µ–º –ø–æ–∫–∞ –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ELK –∑–∞–ø—É—Å—Ç—è—Ç—Å—è
                    echo "Waiting for ELK components to be ready..."
                    sleep 60

                    kubectl wait --for=condition=Ready pod -l app=elasticsearch-master -n ${NAMESPACE_DEV} --timeout=600s || true
                    kubectl wait --for=condition=Ready pod -l app=logstash -n ${NAMESPACE_DEV} --timeout=300s || true
                    kubectl wait --for=condition=Ready pod -l app=kibana -n ${NAMESPACE_DEV} --timeout=300s || true

                    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—à–±–æ—Ä–¥—ã –≤ Kibana
                    echo "Importing Kibana dashboards..."
                    sleep 30
                    curl -X POST http://kibana.${NAMESPACE_DEV}.svc.cluster.local:5601/api/saved_objects/_import \
                        -H "kbn-xsrf: true" \
                        --form file=@kibana/config/dashboards.ndjson || true
                    '''
                }
            }
        }
        stage('Deploy Kafka to DEV') { // –≠—Ç–æ —Å—Ç—Ä–æ–∫–∞ 122 –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            steps {
                dir('charts/kafka') {
                    sh '''
                    helm install kafka . --namespace kafka-dev --create-namespace -f values-dev.yaml --set kafka.replicaCount=1 --set monitoring.enabled=true --set serviceMonitor.enabled=true --set serviceMonitor.namespace=${NAMESPACE_DEV} --set serviceMonitor.labels.release=prometheus-stack
                    '''
                }
            }
        }

        stage('Verify Kafka Deployment') {
            steps {
                script {
                    echo "Waiting for Kafka to be ready..."
                    sh "sleep 60"
                    sh "kubectl rollout status statefulset/kafka-controller -n kafka-dev"
                }
            }
        }

        stage('Create Kafka Topics') {
            steps {
                sh """
                kubectl wait --for=condition=ready pod/kafka-controller-0 -n kafka-dev --timeout=3m

                # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–ø–∏–∫–∞
                create_topic_if_not_exists() {
                    local topic=\$1
                    if ! kubectl exec -n kafka-dev kafka-controller-0 -- kafka-topics.sh --bootstrap-server kafka:9092 --list | grep -q \"^\${topic}\$\"; then
                        echo "Creating topic: \${topic}"
                        kubectl exec -n kafka-dev kafka-controller-0 -- kafka-topics.sh --bootstrap-server kafka:9092 --create --topic \${topic} --partitions 1 --replication-factor 1
                    else
                        echo "Topic '\${topic}' already exists. Skipping."
                    fi
                }
                # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞: –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –±—ã–ª create_topic –≤–º–µ—Å—Ç–æ create_topic_if_not_exists
                create_topic_if_not_exists "service.logs"
                create_topic_if_not_exists "tracing.spans"
                create_topic_if_not_exists "notifications.requests"
                create_topic_if_not_exists "notifications.responses"
                create_topic_if_not_exists "exchange.rates"
                """
            }
        }

        stage('Verify All Components') {
            steps {
                sh '''
                echo "=== VERIFYING ALL COMPONENTS ==="

                echo "1. Monitoring Stack status:"
                kubectl get pods -l app.kubernetes.io/name=prometheus -n ${NAMESPACE_DEV} || true
                kubectl get pods -l app.kubernetes.io/name=grafana -n ${NAMESPACE_DEV} || true
                kubectl get pods -l app=alertmanager -n ${NAMESPACE_DEV} || true
                kubectl get pods -l app=zipkin -n ${NAMESPACE_DEV} || true

                echo "2. ELK Stack status:"
                kubectl get pods -l app=elasticsearch-master -n ${NAMESPACE_DEV} || true
                kubectl get pods -l app=logstash -n ${NAMESPACE_DEV} || true
                kubectl get pods -l app=kibana -n ${NAMESPACE_DEV} || true

                echo "3. Kafka status:"
                kubectl get pods -l app.kubernetes.io/instance=kafka -n kafka-dev || true

                echo "=== ALL COMPONENTS ARE READY ==="
                '''
            }
        }
    }

    post {
        success {
            echo "‚úÖ Full monitoring stack deployed successfully to ${NAMESPACE_DEV}!"
            echo "üîó Access URLs:"
            echo "   Prometheus: http://prometheus.${NAMESPACE_DEV}.svc.cluster.local:9090"
            echo "   Grafana: http://grafana.dev.yourdomain.com (admin/admin)"
            echo "   Alertmanager: http://alertmanager.${NAMESPACE_DEV}.svc.cluster.local:9093"
            echo "   Zipkin: http://zipkin.dev.yourdomain.com"
            echo "   Kibana: http://kibana.dev.yourdomain.com"
        }

        failure {
            echo "‚ùå Deployment failed! Checking component statuses..."
            sh '''
            kubectl get pods -n ${NAMESPACE_DEV}
            kubectl describe pods -n ${NAMESPACE_DEV}
            kubectl logs -l app.kubernetes.io/instance=kafka -n kafka-dev --tail=50 || true
            '''
        }
        always {
            echo "üóÑÔ∏è Build completed. Resources are deployed in namespace: ${NAMESPACE_DEV}"
        }
    }
}