apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: bankapp-alerts
  namespace: monitoring-dev
  labels:
    release: prometheus-stack
spec:
  groups:
    - name: bankapp.rules
      rules:
        # Алерт: Высокий процент ошибок при пополнении счета
        - alert: HighCashOperationErrorRate
          expr: |
            100 * (
              sum(rate(account_cash_operations_total{status="error"}[5m])) 
              / 
              sum(rate(account_cash_operations_total[5m]))
            ) > 10
          for: 3m
          labels:
            severity: warning
          annotations:
            summary: "Высокий процент ошибок при операциях пополнения счета"
            description: "Процент ошибок операций пополнения счета превышает 10% за последние 5 минут."

        # Алерт: Высокое время выполнения операций пополнения
        - alert: HighCashOperationLatency
          expr: |
            histogram_quantile(0.95, sum(rate(account_cash_operation_duration_seconds_bucket[5m])) by (le)) > 5
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Высокое время выполнения операций пополнения"
            description: "95-й перцентиль времени выполнения операций пополнения превышает 5 секунд."

        # Алерт: Частые ошибки "недостаточно средств" при снятии (GET операции)
        - alert: FrequentInsufficientFunds
          expr: |
            sum(rate(account_cash_operations_total{action="GET", result="insufficient_funds"}[5m])) > 5
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Частые ошибки 'недостаточно средств'"
            description: "Более 5 операций снятия со статусом 'недостаточно средств' в минуту за последние 2 минуты."

        # Алерт: Ошибки при работе с отключенными аккаунтами
        - alert: DisabledAccountCashOperations
          expr: sum(rate(account_cash_operations_total{result="account_disabled"}[5m])) > 0
          for: 1m
          labels:
            severity: warning
          annotations:
            summary: "Операции с отключенными аккаунтами"
            description: "Обнаружены попытки операций с отключенными аккаунтами."

        # Алерт: Высокая частота операций пополнения (подозрительная активность)
        - alert: SuspiciousCashOperationVolume
          expr: sum(rate(account_cash_operations_total{action="PUT"}[1m])) > 50
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Подозрительная активность - высокий объем пополнений"
            description: "Обнаружено более 50 операций пополнения в минуту - возможная подозрительная активность."

        # Алерт: Высокое время ответа API
        - alert: HighAPIResponseTime
          expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{job="front-service"}[5m])) by (le)) > 2
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Высокое время ответа API"
            description: "95-й перцентиль времени ответа API превышает 2 секунды в течение последних 2 минут."

        # Алерт: Падение сервиса
        - alert: ServiceDown
          expr: up{job="front-service"} == 0
          for: 1m
          labels:
            severity: critical
          annotations:
            summary: "Сервис недоступен"
            description: "Сервис {{ $labels.instance }} недоступен более 1 минуты."

        # Алерт: Высокий процент ошибок API
        - alert: HighAPIErrorRate
          expr: 100 * (sum(rate(http_server_requests_seconds_count{status=~"5..", job="front-service"}[5m])) / sum(rate(http_server_requests_seconds_count{job="front-service"}[5m]))) > 5
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Высокий процент ошибок API"
            description: "Процент ошибок API превышает 5% в течение последних 2 минут."

        # Алерт: Низкая активность транзакций (для банковского приложения)
        - alert: LowTransactionActivity
          expr: sum(rate(bankapp_transactions_total[5m])) < 1
          for: 5m
          labels:
            severity: info
          annotations:
            summary: "Низкая активность транзакций"
            description: "Количество транзакций в минуту снизилось до менее 1 за последние 5 минут."

        # Алерт: Проблемы с Kafka
        - alert: KafkaConsumerLag
          expr: kafka_consumer_lag > 100
          for: 3m
          labels:
            severity: warning
          annotations:
            summary: "Задержка в обработке сообщений Kafka"
            description: "Задержка обработки сообщений Kafka превышает 100 записей в течение 3 минут."

        # Алерт: Мало свободной памяти
        - alert: LowMemory
          expr: 100 * (1 - (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"})) < 10
          for: 2m
          labels:
            severity: warning
          annotations:
            summary: "Мало свободной памяти JVM"
            description: "Менее 10% свободной памяти в heap JVM на {{ $labels.instance }}."

        # Алерт: Высокая загрузка CPU
        - alert: HighCPUUsage
          expr: 100 * (1 - avg(rate(process_cpu_seconds_total[5m])) by (instance)) > 80
          for: 3m
          labels:
            severity: warning
          annotations:
            summary: "Высокая загрузка CPU"
            description: "Загрузка CPU превышает 80% в течение последних 3 минут на {{ $labels.instance }}."