pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = credentials('DOCKER_REGISTRY')
        DB_PASSWORD     = credentials('DB_PASSWORD')
        GITHUB_USERNAME = credentials('GITHUB_USERNAME')
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        NAMESPACE_DEV = 'kafka-dev'
        NAMESPACE_PROD = 'kafka-prod'
    }

    stages {
         stage('Setup Helm Repo') {
            steps {
                sh '''
                helm repo add bitnami https://raw.githubusercontent.com/bitnami/charts/refs/heads/archive-full-index/bitnami/
                helm repo update
                '''
            }
        }

        stage('Build Chart Dependencies') {
            steps {
                dir('charts/kafka') {
                    sh '''
                    echo "Building chart dependencies..."
                    helm dependency build
                    ls -la charts/
                    cat Chart.yaml
                    '''
                }
            }
        }

        stage('Clean Up Previous Kafka Installation') {
            steps {
                sh '''
                # Удаляем старые ресурсы Kafka если они есть
                helm uninstall kafka --namespace kafka-dev || true
                sleep 10
                # Удаляем старые PVC
                kubectl delete pvc -n kafka-dev data-kafka-controller-0 data-kafka-controller-1 data-kafka-controller-2 || true
                kubectl delete secret -n kafka-dev kafka-kraft || true
                sleep 10
                '''
            }
        }

        stage('Deploy Kafka to DEV') {
                    steps {
                        sh '''
                        echo "Installing Kafka from Bitnami chart..."
                        helm upgrade --install kafka bitnami/kafka \\
                            --namespace kafka-dev --create-namespace \\
                            -f charts/kafka/values-dev.yaml
                            --debug --timeout 10m
                        '''
                    }
                }

        stage('Verify Kafka Deployment') {
                    steps {
                        script {
                            echo "Waiting for Kafka to be ready..."
                            sh "sleep 60"
                            sh "kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=kafka -n ${NAMESPACE_DEV} --timeout=5m"
                        }
                    }
        }

        stage('Create Kafka Topics') {
                    steps {
                        sh """
                        # Подождём, пока под kafka-0 появится
                        kubectl wait --for=condition=ready pod/kafka-0 -n ${NAMESPACE_DEV} --timeout=3m
                        kubectl exec -n ${NAMESPACE_DEV} kafka-0 -- \\
                            kafka-topics.sh --bootstrap-server localhost:9092 \\
                            --create --topic notifications --partitions 1 --replication-factor 1

                        kubectl exec -n ${NAMESPACE_DEV} kafka-0 -- \\
                            kafka-topics.sh --bootstrap-server localhost:9092 \\
                            --create --topic transfers --partitions 1 --replication-factor 1
                        """
                    }
        }

        stage('Manual Approval for PROD') {
                    steps {
                        input message: 'Deploy Kafka to PROD environment?', ok: 'Yes, deploy'
                    }
        }

        stage('Deploy Kafka to PROD') {
            steps {
                     sh '''
                     helm upgrade --install kafka bitnami/kafka \\
                         --namespace kafka-prod --create-namespace \\
                         -f charts/kafka/values-prod.yaml \\
                         --debug --timeout 15m
                     '''
                    }
            }
        }

    post {
        success {
            echo "Kafka deployed successfully!"
        }
        failure {
            echo "Kafka deployment failed!"
        }
    }
}