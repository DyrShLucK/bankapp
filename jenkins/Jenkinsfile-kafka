pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = credentials('DOCKER_REGISTRY')
        DB_PASSWORD     = credentials('DB_PASSWORD')
        GITHUB_USERNAME = credentials('GITHUB_USERNAME')
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        NAMESPACE_DEV = 'kafka-dev'
        NAMESPACE_PROD = 'kafka-prod'
    }

    stages {
         stage('Setup Helm Repo') {
            steps {
                sh '''
                helm repo add bitnami https://raw.githubusercontent.com/bitnami/charts/refs/heads/archive-full-index/bitnami/
                helm repo update
                '''
            }
        }

        stage('Clean Up Previous Kafka Installation') {
            steps {
                sh '''
                if helm status kafka --namespace kafka-dev >/dev/null 2>&1; then
                  echo "Найден существующий релиз Kafka в kafka-dev, удаляем..."
                  helm uninstall kafka --namespace kafka-dev
                  echo "Ожидаем удаления ресурсов Kafka в kafka-dev..."
                  kubectl wait --for=delete pod -l app.kubernetes.io/name=kafka --namespace kafka-dev --timeout=300s || true
                else
                  echo "Релиз Kafka в kafka-dev не найден, пропускаем удаление."
                fi
                kubectl delete secret -n kafka-dev kafka-kraft || true
                '''
            }
        }

        stage('Deploy Kafka to DEV') {
            steps {
                dir('charts/kafka') {
                    sh '''
                    helm install kafka . --namespace kafka-dev --create-namespace -f values-dev.yaml --set replicaCount=1 --wait --timeout=10m
                    '''
                }
            }
        }

        stage('Verify Kafka Deployment in DEV') {
            steps {
                script {
                    echo "Проверка готовности Kafka StatefulSet в ${env.NAMESPACE_DEV}..."
                    sh "kubectl wait --for=condition=Ready pod -l app.kubernetes.io/name=kafka -n ${env.NAMESPACE_DEV} --timeout=300s"
                    echo "Kafka StatefulSet в ${env.NAMESPACE_DEV} готов."
                }
            }
        }

        stage('Create Kafka Topics in DEV') {
            steps {
                script {
                    def kafkaPodName = sh(
                        script: "kubectl get pods -n ${env.NAMESPACE_DEV} -l app.kubernetes.io/name=kafka -o jsonpath='{.items[0].metadata.name}'",
                        returnStdout: true
                    ).trim()

                    if (!kafkaPodName) {
                        error "Не удалось получить имя пода Kafka в ${env.NAMESPACE_DEV}."
                    }

                    echo "Используется под Kafka: ${kafkaPodName} для создания топиков."

                    sh """
                        kubectl exec -n ${env.NAMESPACE_DEV} \${kafkaPodName} -- \\
                            kafka-topics.sh --bootstrap-server localhost:9092 \\
                            --create --topic notifications.requests --partitions 1 --replication-factor 1

                        kubectl exec -n ${env.NAMESPACE_DEV} \${kafkaPodName} -- \\
                            kafka-topics.sh --bootstrap-server localhost:9092 \\
                            --create --topic notifications.responses --partitions 1 --replication-factor 1

                        kubectl exec -n ${env.NAMESPACE_DEV} \${kafkaPodName} -- \\
                            kafka-topics.sh --bootstrap-server localhost:9092 \\
                            --create --topic exchange.rates --partitions 1 --replication-factor 1
                    """
                    echo "Топики Kafka созданы в ${env.NAMESPACE_DEV}."
                }
            }
        }



    post {
        success {
            script {
                echo "Пайплайн Kafka успешно завершён!"
                if (env.NAMESPACE_PROD != null && env.NAMESPACE_PROD != '') {
                    echo "Kafka развернута в ${env.NAMESPACE_DEV} "
                } else {
                    echo "Kafka развернута в ${env.NAMESPACE_DEV}."
                }
            }
        }
        failure {
            echo "Пайплайн Kafka завершился с ошибкой!"
        }
        always {
        }
    }
}