pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = credentials('DOCKER_REGISTRY')
        DB_PASSWORD     = credentials('DB_PASSWORD')
        GITHUB_USERNAME = credentials('GITHUB_USERNAME')
        IMAGE_TAG       = "${env.BUILD_NUMBER}"
        NAMESPACE_DEV = 'kafka-dev'
        NAMESPACE_PROD = 'kafka-prod'
    }

    stages {
         stage('Setup Helm Repo') {
            steps {
                sh """
                helm repo add bitnami https://raw.githubusercontent.com/bitnami/charts/refs/heads/archive-full-index/bitnami/
                helm repo update
                """
            }
        }

        stage('Build Chart Dependencies') {
            steps {
                dir('charts/kafka') {
                    sh """
                    echo "Building chart dependencies..."
                    helm dependency build
                    ls -la charts/
                    cat Chart.yaml
                    """
                }
            }
        }
        stage('Cleanup Previous Installation') {
            steps {
                script {
                    echo "üßπ Cleaning up previous Kafka installation..."
                    sh """
                    # –£–¥–∞–ª—è–µ–º namespace –ø–æ–ª–Ω–æ—Å—Ç—å—é –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                    if kubectl get namespace ${NAMESPACE_DEV} &>/dev/null; then
                        echo "‚ö†Ô∏è  Deleting namespace ${NAMESPACE_DEV} to clean up all resources..."
                        kubectl delete namespace ${NAMESPACE_DEV} --ignore-not-found
                        echo "‚è≥ Waiting for namespace deletion..."
                        sleep 15
                    fi

                    # –°–æ–∑–¥–∞–µ–º namespace –∑–∞–Ω–æ–≤–æ
                    kubectl create namespace ${NAMESPACE_DEV}
                    echo "‚úÖ Namespace ${NAMESPACE_DEV} recreated"
                    """
                }
            }
        }
        stage('Deploy Kafka to DEV') {
            steps {
                sh """
                helm upgrade --install kafka charts/kafka \\
                    --namespace ${NAMESPACE_DEV} --create-namespace \\
                    -f charts/kafka/values-dev.yaml \\
                    --set kafka.replicaCount=2 \\
                    --debug \\
                    --timeout 10m
                """
            }
        }

        stage('Verify Kafka Deployment') {
            steps {
                script {
                    echo "Waiting for Kafka to be ready..."
                    sh "sleep 60"
                    sh "kubectl rollout status statefulset/kafka -n ${NAMESPACE_DEV} --timeout=5m"
                }
            }
        }

        stage('Create Kafka Topics') {
            steps {
                sh """
                kubectl exec -n ${NAMESPACE_DEV} kafka-0 -- \\
                    kafka-topics.sh --bootstrap-server localhost:9092 \\
                    --create --topic notifications --partitions 3 --replication-factor 2

                kubectl exec -n ${NAMESPACE_DEV} kafka-0 -- \\
                    kafka-topics.sh --bootstrap-server localhost:9092 \\
                    --create --topic transfers --partitions 3 --replication-factor 2
                """
            }
        }

        stage('Manual Approval for PROD') {
            steps {
                input message: 'Deploy Kafka to PROD environment?', ok: 'Yes, deploy'
            }
        }

        stage('Deploy Kafka to PROD') {
            steps {
                sh """
                helm upgrade --install kafka charts/kafka \\
                    --namespace ${NAMESPACE_PROD} --create-namespace \\
                    -f charts/kafka/values-prod.yaml \\
                    --set kafka.replicaCount=3 \\
                    --debug \\
                    --timeout 15m
                """
            }
        }
    }

    post {
        success {
            echo "Kafka deployed successfully!"
        }
        failure {
            echo "Kafka deployment failed!"
        }
    }
}