<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Корзина товаров</title>
    <script language="JavaScript">
        // Функция для получения логина из DOM
        function getLoginFromPage() {
            // Вариант 1: Ищем по соседнему элементу с текстом "Логин"
            const loginLabel = Array.from(document.querySelectorAll('td'))
                .find(td => td.textContent.trim() === 'Логин');

            if (loginLabel) {
                // Находим следующий td с colspan="2"
                const loginElement = loginLabel.parentElement.querySelector('td[colspan="2"]');
                if (loginElement && loginElement.textContent) {
                    return loginElement.textContent.trim();
                }
            }

            // Вариант 2: Ищем по структуре таблицы (более надежный)
            const loginRow = Array.from(document.querySelectorAll('tr'))
                .find(tr => {
                    const cells = tr.querySelectorAll('td');
                    return cells.length >= 2 && cells[0].textContent.trim() === 'Логин';
                });

            if (loginRow) {
                const loginCell = loginRow.querySelector('td[colspan="2"]');
                if (loginCell && loginCell.textContent) {
                    return loginCell.textContent.trim();
                }
            }

            // Вариант 3: Если ничего не сработало, ищем по текстовому содержимому
            const allTds = document.querySelectorAll('td[colspan="2"]');
            for (const td of allTds) {
                if (td.textContent && td.textContent.trim() !== '') {
                    // Проверяем, что этот td находится в правильном контексте
                    if (td.closest('table') && td.closest('table').style.backgroundColor === 'whitesmoke') {
                        return td.textContent.trim();
                    }
                }
            }

            return null;
        }

        setInterval(() => {
            var td = document.getElementById('exchange_rates');

            // Создаем оба fetch запроса с timestamp для предотвращения кеширования
            const timestamp = new Date().getTime();

            const request1 = fetch(`http://localhost:8080/exchange?v=${timestamp}`)
                .then(response => {
                    if (!response.ok) throw new Error('Request failed');
                    return response.json();
                });

            const request2 = fetch(`http://bankapp.local/exchange?v=${timestamp}`)
                .then(response => {
                    if (!response.ok) throw new Error('Request failed');
                    return response.json();
                });

            // Используем Promise.allSettled чтобы дождаться обоих запросов
            Promise.allSettled([request1, request2])
                .then(results => {
                    // Проверяем результаты
                    const successfulResults = results.filter(result => result.status === 'fulfilled');

                    if (successfulResults.length > 0) {
                        // Берем данные из первого успешного запроса
                        const json = successfulResults[0].value;
                        renderExchangeTable(td, json);
                    } else {
                        // Оба запроса неудачные
                        td.innerHTML = 'Ошибка при получении данных курсов валют';
                    }
                })
                .catch(error => {
                    td.innerHTML = 'Ошибка при получении данных курсов валют';
                });
        }, 1000);

        // Вынесем рендеринг таблицы в отдельную функцию для переиспользования
        function renderExchangeTable(container, data) {
            var table = '<table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
            table += '<tr><th colspan="3">Курсы валют по отношению к рублю</th></tr>';
            table += '<tr><th>Валюта</th><th>Обозначение</th><th>Курс</th></tr>';
            data.forEach(rate => {
                table += '<tr>';
                table += '<td>' + rate.title + '</td>';
                table += '<td>' + rate.name + '</td>';
                table += '<td>' + rate.cost + '</td>';
                table += '</tr>';
            });
            table += '</table>';
            container.innerHTML = table;
        }

        const displayedNotifications = new Set();

        const userLogin = getLoginFromPage(); // Ваша функция получения логина
        if (!userLogin) {
            console.error("User login not found!");
        }

        // Создаем WebSocket соединение с указанием username
        const wsUri = `ws://localhost:8080/websocket/notifications?username=${encodeURIComponent(userLogin)}`;
        const ws = new WebSocket(wsUri);

        // Множество для отслеживания отображённых уведомлений
        const displayedNotifications = new Set();

        ws.onopen = function(event) {
            console.log("WebSocket connection opened.");
            // Можно отправить запрос на уведомления сразу после подключения, если нужно
            // sendNotificationRequest(); // Если вы хотите вызывать это вручную
        };

        ws.onmessage = function(event) {
            try {
                // Получаем массив уведомлений из сообщения
                const notifications = JSON.parse(event.data);

                if (Array.isArray(notifications) && notifications.length > 0) {
                    notifications.forEach(notification => {
                        if (notification && notification.id && !displayedNotifications.has(notification.id)) {
                            displayedNotifications.add(notification.id);
                            showNotification(notification);
                        }
                    });
                } else {
                    console.log("Received message but no notifications array or it's empty:", event.data);
                }
            } catch (e) {
                console.error("Error parsing WebSocket message:", e, event.data);
            }
        };

        ws.onclose = function(event) {
            console.log("WebSocket connection closed:", event.code, event.reason);
            // Попытка переподключения (опционально)
            // setTimeout(() => { new WebSocket(wsUri); }, 5000);
        };

        ws.onerror = function(error) {
            console.error("WebSocket error:", error);
        };

        // Функция для отправки запроса в Kafka через бэкенд (опционально, если не отправляется автоматически)
        function sendNotificationRequest() {
            // Это может быть вызвано по таймеру или событию
            // frontservice сам отправляет KafkaNotificationRequest при подключении,
            // но если нужно по таймеру, добавьте логику в NotificationWebSocketHandler
        }

        // Функция отображения уведомления (остаётся без изменений)
        function showNotification(notification) {
            const notificationDiv = document.createElement('div');
            notificationDiv.id = `notification-${notification.id}`;
            notificationDiv.className = 'notification';
            notificationDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #4CAF50;
        color: white;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 10px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        opacity: 1;
        transition: opacity 0.5s;
    `;
            notificationDiv.innerHTML = `
        <strong>Уведомление:</strong> ${notification.message || ''}
        <br><small>${notification.timestamp ? new Date(notification.timestamp).toLocaleString() : new Date().toLocaleString()}</small>
        <button onclick="closeNotification('${notification.id}')"
                style="float: right; background: none; border: none; color: white; cursor: pointer;">×</button>
    `;

            document.body.appendChild(notificationDiv);

            setTimeout(() => {
                closeNotification(notification.id);
            }, 5000);
        }

        function closeNotification(notificationId) {
            const notificationDiv = document.getElementById(`notification-${notificationId}`);
            if (notificationDiv) {
                notificationDiv.style.opacity = '0';
                setTimeout(() => {
                    if (notificationDiv.parentNode) {
                        notificationDiv.parentNode.removeChild(notificationDiv);
                    }
                    displayedNotifications.delete(Number(notificationId));
                }, 500);
            }
        }
    </script>
</head>

<body>
<a href="/signup" style="float:right;">
    <b>РЕГИСТРАЦИЯ &plus;</b>
</a>
<br>
<a href="/logout" style="float:right;">
    <b>ВЫЙТИ &cudarrr;</b>
</a>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/editPassword'}">
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <tr>
                <td style="font-weight:bold;">Логин</td>
                <td colspan="2" th:text="${login}"/>
            </tr>
            <tr>
                <td style="font-weight:bold;">Изменить пароль</td>
                <td>
                    <p style="color:red;" th:if="${passwordErrors!=null}" th:each="passwordError : ${passwordErrors}" th:text="${passwordError}"/>
                    <p>
                        Пароль: <input name="password" type="password" required/>
                    </p>
                    <p>
                        Повторите пароль: <input name="confirm_password" type="password" required/>
                    </p>
                </td>
                <td style="text-align:right">
                    <button>Изменить пароль</button>
                </td>
            </tr>
        </table>
        </form>
    </td>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/editUserAccounts'}" >
        <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
            <tr th:if="${userAccountsErrors!=null}" th:each="userAccountsError : ${userAccountsErrors}">
                <td style="color:red;" th:text="${userAccountsError}"/>
            </tr>
            <tr>
                <td style="font-weight:bold;">Фамилия Имя</td>
                <td th:text="${name}"/>
                <td>
                    <input name="name" type="text" style="width:100%"/>
                </td>
            </tr>
            <tr>
                <td style="font-weight:bold;">Дата рождения</td>
                <td th:text="${birthdate}"/>
                <td>
                    <input name="birthdate" type="date" style="width:100%"/>
                </td>
            </tr>
            <tr th:each="account : ${accounts}">
                <td style="font-weight:bold;" th:text="${account.getCurrency().getTitle()}"/>
                <td th:text="${account.isExists ? (account.getBalance()+' '+account.getCurrency().getName()) : ''}"/>
                <td style="text-align:right">
                    <input name="account" type="checkbox" th:checked="${account.isExists}" th:value="${account.getCurrency().getName()}"/>
                </td>
            </tr>
            <tr>
                <td style="text-align:right" colspan="3">
                    <button>Сохранить изменения</button>
                </td>
            </tr>
        </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/cash'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${cashErrors!=null}" th:each="cashError : ${cashErrors}">
                    <td style="color:red;" th:text="${cashError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Наличные</td>
                    <td>
                        Валюта
                        <select name="currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.getName()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" step="0.01" style="width:100%" required/>
                    </td>
                    <td>
                    <td style="text-align:right">
                        <button name="action" value="PUT">Положить</button>
                        <button name="action" value="GET">Снять</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/transfer'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferErrors!=null}" th:each="transferError : ${transferErrors}">
                    <td style="color:red;" th:text="${transferError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод себе</td>
                    <td>
                        Со счета
                        <select name="from_currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.getName()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        На счет
                        <select name="to_currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.getName()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" step="0.01" style="width:100%" required/>
                    </td>
                    <td style="text-align:right">
                        <input hidden name="to_login" th:value="${login}"/>
                        <button>Перевести</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;">
        <form method="post" th:action="${'/transfer'}">
            <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                <tr th:if="${transferOtherErrors!=null}" th:each="transferOtherError : ${transferOtherErrors}">
                    <td style="color:red;" th:text="${transferOtherError}"/>
                </tr>
                <tr>
                    <td style="font-weight:bold;">Перевод другому</td>
                    <td>
                        Со счета
                        <select name="from_currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.getName()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        На счет
                        <select name="to_currency">
                            <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.getName()}" th:text="${eachCurrency.getTitle()}"/>
                        </select>
                    </td>
                    <td>
                        <input name="value" type="number" step="0.01"  required/>
                    </td>
                    <td>
                        Кому
                        <select name="to_login">
                            <option th:each="user : ${users}" th:value="${user.getLogin()}" th:text="${user.getName()}"/>
                        </select>
                    </td>
                    <td style="text-align:right">
                        <button>Перевести</button>
                    </td>
                </tr>
            </table>
        </form>
    </td></tr>
    <tr><td style="padding:2px;" id="exchange_rates">
    </td></tr>
</table>
</body>

</html>